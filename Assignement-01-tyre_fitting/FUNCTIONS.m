% -----------------------------------------------------
tyre_data.Fz0             = 0; % Fz0            
tyre_data.R0              = 0; % R0             
tyre_data.pCx1            = 0; % pCx1           
tyre_data.pCy1            = 0; % pCy1           
tyre_data.pDx1            = 0; % pDx1           
tyre_data.pDx2            = 0; % pDx2           
tyre_data.pDx3            = 0; % pDx3           
tyre_data.pDy1            = 0; % pDy1           
tyre_data.pDy2            = 0; % pDy2           
tyre_data.pDy3            = 0; % pDy3           
tyre_data.pEx1            = 0; % pEx1           
tyre_data.pEx2            = 0; % pEx2           
tyre_data.pEx3            = 0; % pEx3           
tyre_data.pEx4            = 0; % pEx4           
tyre_data.pEy1            = 0; % pEy1           
tyre_data.pEy2            = 0; % pEy2           
tyre_data.pEy3            = 0; % pEy3           
tyre_data.pEy4            = 0; % pEy4           
tyre_data.pHx1            = 0; % pHx1           
tyre_data.pHx2            = 0; % pHx2           
tyre_data.pHy1            = 0; % pHy1           
tyre_data.pHy2            = 0; % pHy2           
tyre_data.pHy3            = 0; % pHy3           
tyre_data.pKx1            = 0; % pKx1           
tyre_data.pKx2            = 0; % pKx2           
tyre_data.pKx3            = 0; % pKx3           
tyre_data.pKy1            = 0; % pKy1           
tyre_data.pKy2            = 0; % pKy2           
tyre_data.pKy3            = 0; % pKy3           
tyre_data.pVx1            = 0; % pVx1           
tyre_data.pVx2            = 0; % pVx2           
tyre_data.pVy1            = 0; % pVy1           
tyre_data.pVy2            = 0; % pVy2           
tyre_data.pVy3            = 0; % pVy3           
tyre_data.pVy4            = 0; % pVy4           
tyre_data.qBz1            = 0; % qBz1           
tyre_data.qBz10           = 0; % qBz10          
tyre_data.qBz2            = 0; % qBz2           
tyre_data.qBz3            = 0; % qBz3           
tyre_data.qBz4            = 0; % qBz4           
tyre_data.qBz5            = 0; % qBz5           
tyre_data.qBz9            = 0; % qBz9           
tyre_data.qCz1            = 0; % qCz1           
tyre_data.qDz1            = 0; % qDz1           
tyre_data.qDz2            = 0; % qDz2           
tyre_data.qDz3            = 0; % qDz3           
tyre_data.qDz4            = 0; % qDz4           
tyre_data.qDz6            = 0; % qDz6           
tyre_data.qDz7            = 0; % qDz7           
tyre_data.qDz8            = 0; % qDz8           
tyre_data.qDz9            = 0; % qDz9           
tyre_data.qEz1            = 0; % qEz1           
tyre_data.qEz2            = 0; % qEz2           
tyre_data.qEz3            = 0; % qEz3           
tyre_data.qEz4            = 0; % qEz4           
tyre_data.qEz5            = 0; % qEz5           
tyre_data.qHz1            = 0; % qHz1           
tyre_data.qHz2            = 0; % qHz2           
tyre_data.qHz3            = 0; % qHz3           
tyre_data.qHz4            = 0; % qHz4           
tyre_data.rBx1            = 0; % rBx1           
tyre_data.rBx2            = 0; % rBx2           
tyre_data.rBy1            = 0; % rBy1           
tyre_data.rBy2            = 0; % rBy2           
tyre_data.rBy3            = 0; % rBy3           
tyre_data.rCx1            = 0; % rCx1           
tyre_data.rCy1            = 0; % rCy1           
tyre_data.rHx1            = 0; % rHx1           
tyre_data.rHy1            = 0; % rHy1           
tyre_data.rVy1            = 0; % rVy1           
tyre_data.rVy2            = 0; % rVy2           
tyre_data.rVy3            = 0; % rVy3           
tyre_data.rVy4            = 0; % rVy4           
tyre_data.rVy5            = 0; % rVy5           
tyre_data.rVy6            = 0; % rVy6           
tyre_data.sSz1            = 0; % sSz1           
tyre_data.sSz2            = 0; % sSz2           
tyre_data.sSz3            = 0; % sSz3           
tyre_data.sSz4            = 0; % sSz4           
tyre_data.lambda__Cx      = 1; % lambda__Cx     
tyre_data.lambda__Cy      = 1; % lambda__Cy     
tyre_data.lambda__Ex      = 1; % lambda__Ex     
tyre_data.lambda__Ey      = 1; % lambda__Ey     
tyre_data.lambda__Fz0     = 1; % lambda__Fz0    
tyre_data.lambda__Hx      = 1; % lambda__Hx     
tyre_data.lambda__Hy      = 1; % lambda__Hy     
tyre_data.lambda__Kxk     = 1; % lambda__Kxk    
tyre_data.lambda__Ky      = 1; % lambda__Ky     
tyre_data.lambda__Kya     = 1; % lambda__Kya    
tyre_data.lambda__Mr      = 1; % lambda__Mr     
tyre_data.lambda__Vx      = 1; % lambda__Vx     
tyre_data.lambda__Vy      = 1; % lambda__Vy     
tyre_data.lambda__Vyk     = 1; % lambda__Vyk    
tyre_data.lambda__gamma__y = 1; % lambda__gamma__y
tyre_data.lambda__mu__x   = 1; % lambda__mu__x  
tyre_data.lambda__mu__y   = 1; % lambda__mu__y  
tyre_data.lambda__s       = 1; % lambda__s      
tyre_data.lambda__t       = 1; % lambda__t      
tyre_data.lambda__xa      = 1; % lambda__xa     
tyre_data.lambda__yk      = 1; % lambda__yk     
% -----------------------------------------------------
% -----------------------------------------------------
% Implement the Magic formula
function [mf_res] = magic_formula(x, B, C, D, E, SV)

	% precode
	
	
	
	% main code
	
	t1 = B * x;
	t2 = atan(t1);
	t6 = atan(-t1 + (t1 - t2) * E);
	t8 = sin(t6 * C);
	mf_res = -t8 * D + SV;
	
end
% -----------------------------------------------------
% -----------------------------------------------------
% Coefficients for Magic Formula pure longitudinal force
function [kappa__x, Bx, Cx, Dx, Ex, SVx, Kxk] = MF96_FX0_coeffs(kappa, alpha, phi, Fz, tyre_data)

	% precode
   
	 Fz0             = tyre_data.Fz0;
	 pCx1            = tyre_data.pCx1;
	 pDx1            = tyre_data.pDx1;
	 pDx2            = tyre_data.pDx2;
	 pDx3            = tyre_data.pDx3;
	 pEx1            = tyre_data.pEx1;
	 pEx2            = tyre_data.pEx2;
	 pEx3            = tyre_data.pEx3;
	 pEx4            = tyre_data.pEx4;
	 pHx1            = tyre_data.pHx1;
	 pHx2            = tyre_data.pHx2;
	 pKx1            = tyre_data.pKx1;
	 pKx2            = tyre_data.pKx2;
	 pKx3            = tyre_data.pKx3;
	 pVx1            = tyre_data.pVx1;
	 pVx2            = tyre_data.pVx2;
	 lambda__Cx      = tyre_data.lambda__Cx;
	 lambda__Ex      = tyre_data.lambda__Ex;
	 lambda__Fz0     = tyre_data.lambda__Fz0;
	 lambda__Hx      = tyre_data.lambda__Hx;
	 lambda__Kxk     = tyre_data.lambda__Kxk;
	 lambda__Vx      = tyre_data.lambda__Vx;
	 lambda__mu__x   = tyre_data.lambda__mu__x;
	 lambda__gamma__y = tyre_data.lambda__gamma__y;
	 
   
	% main code
   
	 Fz01 = (lambda__Fz0 * Fz0);
	 dfz = Fz / Fz01 - 1;
	 SHx = (dfz * pHx2 + pHx1) * lambda__Hx;
	 SVx = Fz * (dfz * pVx2 + pVx1) * lambda__Vx * lambda__mu__x;
	 gamma__s = (phi * lambda__gamma__y);
	 kappa__x = kappa + SHx;
	 Cx = pCx1 * lambda__Cx;
	 mu__x = (dfz * pDx2 + pDx1) * (-pDx3 * gamma__s ^ 2 + 1) * lambda__mu__x;
	 Dx = mu__x * Fz;
	 Kxk = Fz * (dfz * pKx2 + pKx1) * exp(-(pKx3 * dfz)) * lambda__Kxk;
	 Ex = (dfz ^ 2 * pEx3 + dfz * pEx2 + pEx1) * (1 - pEx4 * sign(kappa__x)) * lambda__Ex;
	 Bx = Kxk / Cx / Dx;
	 
end
% -----------------------------------------------------
% -----------------------------------------------------	  
% Pure longitudinal force FX0
function [fx0] = MF96_FX0(kappa, alpha, phi, Fz, tyre_data)

	% precode
   
	 [kappa__x, Bx, Cx, Dx, Ex, SVx] = MF96_FX0_coeffs(kappa, alpha, phi, Fz, tyre_data);
   
	% main code
   
	 fx0 = magic_formula(kappa__x, Bx, Cx, Dx, Ex, SVx);
	 
	end
% -----------------------------------------------------
% -----------------------------------------------------   
% Coefficients for Magic Formula pure lateral force
function [alpha__y, By, Cy, Dy, Ey, SVy, Kya, SHy, mu__y] = MF96_FY0_coeffs(kappa, alpha, phi, Fz, tyre_data)

	% precode
   
	 Fz0             = tyre_data.Fz0;
	 pCy1            = tyre_data.pCy1;
	 pDy1            = tyre_data.pDy1;
	 pDy2            = tyre_data.pDy2;
	 pDy3            = tyre_data.pDy3;
	 pEy1            = tyre_data.pEy1;
	 pEy2            = tyre_data.pEy2;
	 pEy3            = tyre_data.pEy3;
	 pEy4            = tyre_data.pEy4;
	 pHy1            = tyre_data.pHy1;
	 pHy2            = tyre_data.pHy2;
	 pHy3            = tyre_data.pHy3;
	 pKy1            = tyre_data.pKy1;
	 pKy2            = tyre_data.pKy2;
	 pKy3            = tyre_data.pKy3;
	 pVy1            = tyre_data.pVy1;
	 pVy2            = tyre_data.pVy2;
	 pVy3            = tyre_data.pVy3;
	 pVy4            = tyre_data.pVy4;
	 lambda__Cy      = tyre_data.lambda__Cy;
	 lambda__Ey      = tyre_data.lambda__Ey;
	 lambda__Fz0     = tyre_data.lambda__Fz0;
	 lambda__Hy      = tyre_data.lambda__Hy;
	 lambda__Kya     = tyre_data.lambda__Kya;
	 lambda__Vy      = tyre_data.lambda__Vy;
	 lambda__mu__y   = tyre_data.lambda__mu__y;
	 lambda__gamma__y = tyre_data.lambda__gamma__y;
	 
   
	% main code
   
	 Fz01 = (lambda__Fz0 * Fz0);
	 dfz = Fz / Fz01 - 1;
	 gamma__s = (phi * lambda__gamma__y);
	 SHy = (dfz * pHy2 + pHy3 * gamma__s + pHy1) * lambda__Hy;
	 SVy = Fz * (pVy1 + pVy2 * dfz + (dfz * pVy4 + pVy3) * gamma__s) * lambda__Vy * lambda__mu__y;
	 alpha__y = alpha + SHy;
	 Cy = pCy1 * lambda__Cy;
	 mu__y = (dfz * pDy2 + pDy1) * (-pDy3 * gamma__s ^ 2 + 1) * lambda__mu__y;
	 Dy = mu__y * Fz;
	 Ey = (dfz * pEy2 + pEy1) * (1 - (pEy4 * gamma__s + pEy3) * sign(alpha__y)) * lambda__Ey;
	 Kya = Fz01 * pKy1 * sin(0.2e1 * atan((Fz / Fz01 / pKy2))) * (1 - pKy3 * abs(gamma__s)) * lambda__Fz0 * lambda__Kya;
	 By = Kya / Cy / Dy;
	 
end
% -----------------------------------------------------
% -----------------------------------------------------
% Pure lateral force FY0
function [fy0] = MF96_FY0(kappa, alpha, phi, Fz, tyre_data)

	% precode
   
	 [alpha__y,By,Cy,Dy,Ey,SVy] = MF96_FY0_coeffs(kappa, alpha, phi, Fz, tyre_data);
   
	% main code
   
	 fy0 = magic_formula(alpha__y, By, Cy, Dy, Ey, SVy);
	 
	end
% -----------------------------------------------------
% -----------------------------------------------------
% Coefficients for Magic Formula pure self-aligning moment
function [Br, Bt, Ct, Dr, Dt, Et, alpha__r, alpha__t, alpha__t__eq, alpha__r__eq, s] = MF96_MZ_coeffs(kappa, alpha, phi, Fz, tyre_data)

	% precode
   
	 Fz0             = tyre_data.Fz0;
	 R0              = tyre_data.R0;
	 qBz1            = tyre_data.qBz1;
	 qBz10           = tyre_data.qBz10;
	 qBz2            = tyre_data.qBz2;
	 qBz3            = tyre_data.qBz3;
	 qBz4            = tyre_data.qBz4;
	 qBz5            = tyre_data.qBz5;
	 qBz9            = tyre_data.qBz9;
	 qCz1            = tyre_data.qCz1;
	 qDz1            = tyre_data.qDz1;
	 qDz2            = tyre_data.qDz2;
	 qDz3            = tyre_data.qDz3;
	 qDz4            = tyre_data.qDz4;
	 qDz6            = tyre_data.qDz6;
	 qDz7            = tyre_data.qDz7;
	 qDz8            = tyre_data.qDz8;
	 qDz9            = tyre_data.qDz9;
	 qEz1            = tyre_data.qEz1;
	 qEz2            = tyre_data.qEz2;
	 qEz3            = tyre_data.qEz3;
	 qEz4            = tyre_data.qEz4;
	 qEz5            = tyre_data.qEz5;
	 qHz1            = tyre_data.qHz1;
	 qHz2            = tyre_data.qHz2;
	 qHz3            = tyre_data.qHz3;
	 qHz4            = tyre_data.qHz4;
	 sSz1            = tyre_data.sSz1;
	 sSz2            = tyre_data.sSz2;
	 sSz3            = tyre_data.sSz3;
	 sSz4            = tyre_data.sSz4;
	 lambda__Fz0     = tyre_data.lambda__Fz0;
	 lambda__Ky      = tyre_data.lambda__Ky;
	 lambda__Mr      = tyre_data.lambda__Mr;
	 lambda__mu__y   = tyre_data.lambda__mu__y;
	 lambda__s       = tyre_data.lambda__s;
	 lambda__t       = tyre_data.lambda__t;
	 lambda__gamma__y = tyre_data.lambda__gamma__y;
	 
	 
	 if sSz1 ~= 0
		  fy = MF96_FY(kappa, alpha, phi, Fz, tyre_data);
	 else
		  fy = 0;
	 end
	 
	 [alpha__y, By, Cy, Dy, Ey, SVy, Kya, SHy] = MF96_FY0_coeffs(kappa, alpha, phi, Fz, tyre_data);
	 [kappa__x, Bx, Cx, Dx, Ex, SVx, Kxk] = MF96_FX0_coeffs(kappa, alpha, phi, Fz, tyre_data);
	 
   
	% main code
   
	 Fz01 = (lambda__Fz0 * Fz0);
	 dfz = Fz / Fz01 - 1;
	 gamma__z = (phi * lambda__gamma__y);
	 SHf = (SHy + SVy / Kya);
	 SHt = qHz1 + qHz2 * dfz + (dfz * qHz4 + qHz3) * gamma__z;
	 alpha__t = alpha + SHt;
	 alpha__r = alpha + SHf;
	 Bt = (dfz ^ 2 * qBz3 + dfz * qBz2 + qBz1) * (1 + qBz4 * gamma__z + qBz5 * abs(gamma__z)) * lambda__Ky / lambda__mu__y;
	 Ct = qCz1;
	 Dt = Fz * (dfz * qDz2 + qDz1) * (qDz4 * gamma__z ^ 2 + qDz3 * gamma__z + 1) * R0 / Fz0 * lambda__t;
	 Et = (dfz ^ 2 * qEz3 + dfz * qEz2 + qEz1) * (0.1e1 + (qEz5 * gamma__z + qEz4) * atan((Bt * Ct * alpha__t)));
	 Br = qBz9 * lambda__Ky / lambda__mu__y + qBz10 * By * Cy;
	 Dr = Fz * (qDz6 + qDz7 * dfz + (dfz * qDz9 + qDz8) * gamma__z) * R0 * lambda__mu__y * lambda__Mr;
	 alpha__t__eq = atan(sqrt(tan(alpha__t) ^ 2 + Kxk ^ 2 / Kya ^ 2 * kappa ^ 2)) * sign(alpha__t);
	 alpha__r__eq = atan(sqrt(tan(alpha__r) ^ 2 + Kxk ^ 2 / Kya ^ 2 * kappa ^ 2)) * sign(alpha__r);
	 s = (sSz1 + sSz2 * fy / Fz0 + (dfz * sSz4 + sSz3) * gamma__z) * R0 * lambda__s;
	 
end
% -----------------------------------------------------
% -----------------------------------------------------
% Pure self-aligning moment MZ0
function [mz0] = MF96_MZ0(kappa, alpha, phi, Fz, tyre_data)

	% precode
   
	 fy0 = MF96_FY0(kappa, alpha, phi, Fz, tyre_data);
	 [Br, Bt, Ct, Dr, Dt, Et, alpha__r, alpha__t, alpha__t__eq, alpha__r__eq, s] = MF96_MZ_coeffs(kappa, alpha, phi, Fz, tyre_data);
	 t = pneumatic_trail(alpha__t, alpha, Bt, Ct, Dt, Et);
	 mzr = residual_mzr(alpha__r, alpha, Br, Dr);
   
	% main code
   
	 mz0 = -fy0 * t + mzr;
	 
	end
% -----------------------------------------------------
% -----------------------------------------------------
% Coefficients for Magic Formula combined forces
function [Gxa, Gyk, SVyk] = MF96_FXFYCOMB_coeffs(kappa, alpha, phi, Fz, tyre_data)

	% precode
   
	 Fz0             = tyre_data.Fz0;
	 rBx1            = tyre_data.rBx1;
	 rBx2            = tyre_data.rBx2;
	 rBy1            = tyre_data.rBy1;
	 rBy2            = tyre_data.rBy2;
	 rBy3            = tyre_data.rBy3;
	 rCx1            = tyre_data.rCx1;
	 rCy1            = tyre_data.rCy1;
	 rHx1            = tyre_data.rHx1;
	 rHy1            = tyre_data.rHy1;
	 rVy1            = tyre_data.rVy1;
	 rVy2            = tyre_data.rVy2;
	 rVy3            = tyre_data.rVy3;
	 rVy4            = tyre_data.rVy4;
	 rVy5            = tyre_data.rVy5;
	 rVy6            = tyre_data.rVy6;
	 lambda__Fz0     = tyre_data.lambda__Fz0;
	 lambda__Vyk     = tyre_data.lambda__Vyk;
	 lambda__xa      = tyre_data.lambda__xa;
	 lambda__yk      = tyre_data.lambda__yk;
	 
	 [alpha__y, By, Cy, Dy, Ey, SVy, Kya, SHy, mu__y] = MF96_FY0_coeffs(kappa, alpha, phi, Fz, tyre_data);
	 
   
	% main code
   
	 Fz01 = (lambda__Fz0 * Fz0);
	 dfz = Fz / Fz01 - 1;
	 SHxa = rHx1;
	 Bxa = rBx1 * (kappa ^ 2 * rBx2 ^ 2 + 1) ^ (-0.1e1 / 0.2e1) * lambda__xa;
	 Cxa = rCx1;
	 Dxa = 0.1e1 / cos(Cxa * atan((Bxa * SHxa)));
	 Gxa = Dxa * cos(Cxa * atan((Bxa * (alpha + SHxa))));
	 SHyk = rHy1;
	 DVyk = mu__y * Fz * (dfz * rVy2 + phi * rVy3 + rVy1) * (alpha ^ 2 * rVy4 ^ 2 + 1) ^ (-0.1e1 / 0.2e1);
	 SVyk = DVyk * sin(rVy5 * atan((rVy6 * kappa))) * lambda__Vyk;
	 Byk = rBy1 * (1 + rBy2 ^ 2 * (alpha - rBy3) ^ 2) ^ (-0.1e1 / 0.2e1) * lambda__yk;
	 Cyk = rCy1;
	 Dyk = 0.1e1 / cos(Cyk * atan((Byk * SHyk)));
	 Gyk = Dyk * cos(Cyk * atan((Byk * (kappa + SHyk))));
	 
	end
% -----------------------------------------------------
% -----------------------------------------------------
% Combined longitudinal force FX
function [fx] = MF96_FX(kappa, alpha, phi, Fz, tyre_data)

	% precode
   
	 fx0 = MF96_FX0(kappa, alpha, phi, Fz, tyre_data);
	 [Gxa, Gyk, SVyk] = MF96_FXFYCOMB_coeffs(kappa, alpha, phi, Fz, tyre_data);
   
	% main code
   
	 fx = fx0 * Gxa;
	 
	end
% -----------------------------------------------------
% -----------------------------------------------------
% Combined lateral force FY
function [fy] = MF96_FY(kappa, alpha, phi, Fz, tyre_data)

	% precode
   
	 fy0 = MF96_FY0(kappa, alpha, phi, Fz, tyre_data);
	 [Gxa, Gyk, SVyk] = MF96_FXFYCOMB_coeffs(kappa, alpha, phi, Fz, tyre_data);
   
	% main code
   
	 fy = fy0 * Gyk + SVyk;
	 
end
   